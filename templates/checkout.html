<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø§Ù„Ø¯ÙØ¹ - {{ course.title }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PayPal SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id=BAAJcox7yFIYUK_9fr0DsH_V-JEoMg4YTjK2tsURwsHGJ2mwE88hNibmgeqC4MMOFptDpW7FVjSJTeHUWc&currency=USD"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="container mx-auto py-10 max-w-md">
    <h2 class="text-2xl font-bold mb-6">ğŸ’³ Ø§Ù„Ø¯ÙØ¹ Ù„Ù€: {{ course.title }}</h2>

    {% if success %}
      <div class="bg-green-100 text-green-800 p-4 rounded mb-4">
        âœ… ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­! ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯ÙˆØ±Ø© Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ.
      </div>
    {% elif success is not none %}
      <div class="bg-red-100 text-red-800 p-4 rounded mb-4">
        âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: {{ error }}
      </div>
    {% endif %}

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª -->
    <form method="POST" id="userForm" class="space-y-4">
      <input type="text" name="full_name" id="full_name" required placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„"
             class="w-full p-2 border rounded" />
      <input type="email" name="email" id="email" required placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"
             class="w-full p-2 border rounded" />
    </form>

    <!-- Ø²Ø± PayPal -->
    <div class="mt-6" id="paypal-button-container"></div>
<script>
  paypal.Buttons({
    createOrder: function(data, actions) {
      const fullName = document.getElementById("full_name").value;
      const email = document.getElementById("email").value;

      if (!fullName || !email) {
        alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆØ§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.");
        return;
      }

      // Ù†Ø±Ø³Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù… Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ø¯ÙØ¹
      return fetch("/checkout/{{ course.id }}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: new URLSearchParams({
          full_name: fullName,
          email: email,
          stage: "before_payment"
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø­ÙØ¸ØŒ Ù†Ø¨Ø¯Ø£ Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹
          return actions.order.create({
            purchase_units: [{
              amount: {
                value: '{{ course.price }}'
              }
            }]
          });
        } else {
          alert("âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + data.error);
          return;
        }
      })
      .catch(error => {
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…: " + error);
      });
    },

    onApprove: function(data, actions) {
      return actions.order.capture().then(function(details) {
        // Ø§Ù„Ø¯ÙØ¹ ØªÙ… Ø¨Ù†Ø¬Ø§Ø­ØŒ ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ ÙÙ‚Ø· Ø£Ùˆ ØªØ³Ø¬ÙŠÙ„ Ø°Ù„Ùƒ Ù„Ø§Ø­Ù‚Ù‹Ø§
        const successDiv = document.createElement("div");
        successDiv.className = "bg-green-100 text-green-800 p-4 rounded mb-4";
        successDiv.innerText = "âœ… ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¯ÙˆØ±Ø© Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹.";
        document.querySelector(".container").prepend(successDiv);
      });
    }
  }).render('#paypal-button-container');
</script>

  </div>
</body>
</html>
