<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>الدفع - {{ course.title }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PayPal SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id=BAAJcox7yFIYUK_9fr0DsH_V-JEoMg4YTjK2tsURwsHGJ2mwE88hNibmgeqC4MMOFptDpW7FVjSJTeHUWc&currency=USD"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="container mx-auto py-10 max-w-md">
    <h2 class="text-2xl font-bold mb-6">💳 الدفع لـ: {{ course.title }}</h2>

    {% if success %}
      <div class="bg-green-100 text-green-800 p-4 rounded mb-4">
        ✅ تم الدفع بنجاح! تم إرسال رابط الدورة إلى بريدك.
      </div>
    {% elif success is not none %}
      <div class="bg-red-100 text-red-800 p-4 rounded mb-4">
        ❌ خطأ أثناء الإرسال: {{ error }}
      </div>
    {% endif %}

    <!-- نموذج المعلومات -->
    <form method="POST" id="userForm" class="space-y-4">
      <input type="text" name="full_name" id="full_name" required placeholder="الاسم الكامل"
             class="w-full p-2 border rounded" />
      <input type="email" name="email" id="email" required placeholder="البريد الإلكتروني"
             class="w-full p-2 border rounded" />
    </form>

    <!-- زر PayPal -->
    <div class="mt-6" id="paypal-button-container"></div>
<script>
  paypal.Buttons({
    createOrder: function(data, actions) {
      const fullName = document.getElementById("full_name").value;
      const email = document.getElementById("email").value;

      if (!fullName || !email) {
        alert("يرجى إدخال الاسم الكامل والبريد الإلكتروني.");
        return;
      }

      // نرسل البيانات إلى الخادم قبل بدء الدفع
      return fetch("/checkout/{{ course.id }}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: new URLSearchParams({
          full_name: fullName,
          email: email,
          stage: "before_payment"
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // إذا تم الحفظ، نبدأ إنشاء عملية الدفع
          return actions.order.create({
            purchase_units: [{
              amount: {
                value: '{{ course.price }}'
              }
            }]
          });
        } else {
          alert("❌ فشل في حفظ البيانات: " + data.error);
          return;
        }
      })
      .catch(error => {
        alert("❌ حدث خطأ في الاتصال بالخادم: " + error);
      });
    },

    onApprove: function(data, actions) {
      return actions.order.capture().then(function(details) {
        // الدفع تم بنجاح، يمكننا عرض رسالة نجاح فقط أو تسجيل ذلك لاحقًا
        const successDiv = document.createElement("div");
        successDiv.className = "bg-green-100 text-green-800 p-4 rounded mb-4";
        successDiv.innerText = "✅ تم الدفع بنجاح! سيتم إرسال الدورة إلى بريدك الإلكتروني قريباً.";
        document.querySelector(".container").prepend(successDiv);
      });
    }
  }).render('#paypal-button-container');
</script>

  </div>
</body>
</html>
